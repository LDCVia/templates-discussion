/*! lowladb 2014-Dec-22 */
!function(a){"use strict";function b(a){if(!(this instanceof b))return new b(a);var c=this.config={};if(b.utils.keys(b._defaultOptions).forEach(function(a){c[a]=b._defaultOptions[a]}),b.utils.keys(a).forEach(function(b){c[b]=a[b]}),this.datastore=b._datastores[c.datastore],!this.datastore)throw Error("Invalid or unavailable datastore: "+c.datastore);this.events={},this.liveCursors={}}function c(a,c){b._datastores[a]=c}function d(a){return new b.DB(this,a)}function e(a,c){return new b.Collection(this,a,c)}function f(a,c){function d(){return e._syncing?void(e._pendingSync=!0):(e._syncing=!0,e.emit("syncBegin"),e._syncCoordinator.pushChanges().then(function(){return e._syncCoordinator.fetchChanges()}).then(function(a){return e._syncing=!1,e.emit("syncEnd"),e._pendingSync?(e._pendingSync=!1,d()):a},function(a){throw e._syncing=e._pendingSync=!1,e.emit("syncEnd"),a}))}var e=this;if(c=c||{},e._syncCoordinator=new b.SyncCoordinator(e,a,c),!c||-1!==c.pollFrequency){var f=(c.io||window.io)&&(c.socket||void 0===c.socket);if(f&&!c.pollFrequency){var g=c.io||window.io,h=b.utils.debounce(d,250),i=g.connect(a);i.on("changes",function(){h()}),i.on("reconnect",function(){h()}),e.on("_pending",function(){h()})}return d().then(function(){if(c.pollFrequency){var a=function(){d().then(function(){setTimeout(a,1e3*c.pollFrequency)})};setTimeout(a,1e3*c.pollFrequency)}},function(a){throw a})}}function g(a,b){var c=this.events;c[a]?c[a].push(b):c[a]=[b]}function h(a,b){var c=this.events;if(b){if(c[a]){var d=c[a].indexOf(b);-1!==d&&c[a].splice(d,1)}}else a?delete c[a]:this.events={}}function i(){var a=Array.prototype.slice.call(arguments),b=a.shift(),c=this.events;c[b]&&c[b].forEach(function(b){b.apply(b,a)})}function j(){this.off(),this._cursorsOff(),this.datastore.close()}function k(a,c){var d=this;return Promise.resolve().then(function(){return"string"==typeof a?b.utils.getJSON(a).then(function(a){return d._processLoadPayload(a)}):d._processLoadPayload(a)}).then(function(a){return c&&c(null,a),a},function(a){throw c&&c(a),a})}function l(a,c){var d=this;return c||(c=0),b.SyncCoordinator._processPullPayload(d,d.datastore,a.documents[c]).then(function(){return++c,c<a.documents.length?d._processLoadPayload(a,c):void 0}).then(function(){return b.SyncCoordinator._updateSequence(d,a.sequence)})}function m(a){var b=this.datastore;return new Promise(a?function(c,d){b.updateDocument("","$metadata",a,c,d)}:function(a,c){b.loadDocument("","$metadata",a,c)})}function n(){this.liveCursors={}}function o(a,b){return this.config.lowlaId?this.config.lowlaId(a,b):a.dbName+"."+a.collectionName+"$"+b._id}return a.LowlaDB=b,b.registerDatastore=c,b.prototype.close=j,b.prototype.collection=e,b.prototype.db=d,b.prototype.emit=i,b.prototype.load=k,b.prototype.on=g,b.prototype.off=h,b.prototype.sync=f,b._datastores={},b._defaultOptions={datastore:"IndexedDB"},b.prototype._metadata=m,b.prototype._cursorsOff=n,b.prototype._processLoadPayload=l,b.prototype._generateLowlaId=o,b}("object"==typeof exports?exports:window),function(a){"use strict";function b(a,b,c){this.dbName=b,this.collectionName=c,this.lowla=a,this.datastore=a.datastore}function c(){var a,b,c="";for(a=0;32>a;a++)b=16*Math.random()|0,(8===a||12===a||16===a||20===a)&&(c+="-"),c+=(12===a?4:16===a?3&b|8:b).toString(16);return c}function d(a,b){var c=!1;for(var d in b)if(b.hasOwnProperty(d))if("$set"===d){c=!0;for(var e in b[d])if(b[d].hasOwnProperty(e)){if(0===e.indexOf("$"))throw Error("The dollar ($) prefixed field "+e+" is not valid");a[e]=b[d][e]}}else if("$unset"===d){c=!0;for(var f in b[d])b[d].hasOwnProperty(f)&&a.hasOwnProperty(f)&&delete a[f]}else{if("$"===d.substring(0,1))throw Error(c?"Unknown modifier: "+d:"The dollar ($) prefixed field "+d+" is not valid");if(c)throw Error("Can not mix operations and values in object updates")}return c?a:(!b.hasOwnProperty("_id")&&a.hasOwnProperty("_id")&&(b._id=a._id),b)}function e(a,b,c,d){var e=this,f=null;return new Promise(function(g,h){function i(a){e._removeDocumentInTx(a,d,!0,function(){j(a)})}function j(d){e._updateDocumentInTx(d,a,b,c,function(a){f=a})}e.datastore.transact(d?i:j,g,h)}).then(function(){return f})}function f(b,d,e,f,g){function h(a,b){void 0===b&&(b=a),b.save(l,d,e,i)}function i(b){g(b),a.Cursor.notifyLive(k)}g=g||function(){};var k=this;e._id=e._id||c(),d=d||k.lowla._generateLowlaId(k,e);var l=k.dbName+"."+k.collectionName;k.lowla.emit("_saveHook",e,d),f?h(b):j(b,l,d,h,e)}function g(a,b){var c=this;return new Promise(function(d,e){function f(d){c._removeDocumentInTx(d,a,b)}c.datastore.transact(f,d,e)})}function h(a,b,c,d){function e(a,c){void 0===c&&(c=a),c.remove(g,b,f)}function f(){d()}d=d||function(){};var g=this.dbName+"."+this.collectionName;c?e(a):j(a,g,b,e)}function i(b,c){var d=a.utils.keys(b),e=a.utils.keys(c);if(d.length!=e.length)return!1;var f=!0;return a.utils.keys(b).forEach(function(a){if(!f)return f;if(!c.hasOwnProperty(a))return f=!1;if(b[a]instanceof Object){if(!(c[a]instanceof Object))return f=!1;f=i(b[a],c[a])}else f=JSON.stringify(b[a])===JSON.stringify(c[a])}),f}function j(a,b,c,d,e){function f(a,f){function g(b,e){b=b||{},a=a||{changes:{}},a.changes=a.changes||{},a.changes[c]=b,e.save("","$metadata",a,d)}a&&a.changes&&a.changes[c]?e&&i(a.changes[c],e)?(delete a.changes[c],f.save("","$metadata",a,d)):d(a,f):f.load(b,c,g)}a.load("","$metadata",f)}function k(b,c){var d=this,e=[];return new Promise(function(c,f){function g(a){function b(f){e.push(f),++c,c<h.length&&d._updateDocumentInTx(a,null,h[c],!1,b)}var c=0;d._updateDocumentInTx(a,null,h[c],!1,b)}var h=a.utils.isArray(b)?b:[b];h.forEach(function(b){a.utils.keys(b).forEach(function(a){"$"===a.substring(0,1)&&f(Error("The dollar ($) prefixed field "+a+" is not valid"))})}),d.datastore.transact(g,c,f)}).then(function(){return d.lowla.emit("_pending"),a.utils.isArray(b)||(e=e.length?e[0]:null),c&&c(null,e),e}).catch(function(a){throw c&&c(a),a})}function l(b,c){var d=this;return Promise.resolve().then(function(){return a.Cursor(d,b).limit(1).toArray()}).then(function(a){var b=a&&a.length>0?a[0]:void 0;return c&&c(null,b),b},function(a){throw c&&c(a),a})}function m(b){return a.Cursor(this,b)}function n(a,b,c){var e=this,f=null;return new Promise(function(c,g){function h(b){e.find(a)._applyFilterInTx(b,i)}function i(a,c){if(0!==a.length){var h=d(a[0].document,b);e._updateDocumentInTx(c,a[0].lowlaId,h,!1,function(a){f=a},g)}}e.datastore.transact(h,c,g)}).then(function(){return e.lowla.emit("_pending"),c&&c(null,f),f},function(a){throw c&&c(a),a})}function o(b,c){var d=this;return"function"==typeof b&&(c=b,b={}),Promise.resolve().then(function(){return d.find(b)._applyFilter()}).then(function(b){var c=0;return new Promise(function(a,e){function f(a){b.map(function(b){d.lowla.emit("_saveHook",null,b.lowlaId),d._removeDocumentInTx(a,b.lowlaId,!1,function(){c+=1})})}return 0===b.length?void a(0):void d.datastore.transact(f,a,e)}).then(function(){return a.Cursor.notifyLive(d),c})}).then(function(a){return d.lowla.emit("_pending"),c&&c(null,a),a},function(a){throw c&&c(a),a})}function p(a,b){return"function"==typeof a&&(b=a,a={}),this.find(a).count(b)}return a.Collection=b,b.prototype.insert=k,b.prototype.findOne=l,b.prototype.find=m,b.prototype.findAndModify=n,b.prototype.remove=o,b.prototype.count=p,b.prototype._updateDocument=e,b.prototype._updateDocumentInTx=f,b.prototype._removeDocument=g,b.prototype._removeDocumentInTx=h,a}(LowlaDB),function(a){"use strict";function b(a,c,d){if(!(this instanceof b))return new b(a,c,d);this._lowla=a.lowla,this._collection=a,this._filter=c,this._options={sort:null,limit:0,showPending:!1};for(var e in d)d.hasOwnProperty(e)&&(this._options[e]=d[e])}function c(a,b){for(var c in a)if(a.hasOwnProperty(c)&&(!b.hasOwnProperty(c)||a[c]!==b[c]))return!1;return!0}function d(a,b,c){return b=b.document,c=c.document,b.hasOwnProperty(a)?c.hasOwnProperty(a)?b[a]<c[a]?-1:b[a]==c[a]?0:1:1:c.hasOwnProperty(a)?-1:0}function e(b,e){function f(a){a.clientNs===l&&c(m._filter,a.document)&&j.push(a)}function g(){if(j=j.map(a.SyncCoordinator.convertSpecialTypes),m._options.sort&&i(),m._options.limit&&(j=j.slice(0,m._options.limit)),j.length&&m._options.showPending)b.load("","$metadata",h);else try{e(j,b)}catch(c){b.errCb(c)}}function h(a,b){a&&a.changes&&j.forEach(function(b){b.document.$pending=a.changes.hasOwnProperty(b.lowlaId)}),e(j,b)}function i(){var a=m._options.sort;j.sort(function(b,c){if("string"==typeof a)return d(a,b,c);if(a instanceof Array){var e=0;return a.every(function(a){var f,g;return a instanceof Array?(f=a[0],g=a.length>0?a[1]:1):(f=a,g=1),e=d(f,b,c),0>g&&(e=-e),0===e}),e}})}var j=[],k=this._collection,l=k.dbName+"."+k.collectionName,m=this,n={};m._filter&&m._filter.hasOwnProperty("_id")&&(n.clientNs=l,n._id=m._filter._id),b.scan({document:f,done:g,options:n})}function f(){var a,b=this;return new Promise(function(c,d){function e(c){b._applyFilterInTx(c,function(b){a=b})}b._collection.datastore.transact(e,c,d)}).then(function(){return a})}function g(a){var b=a.dbName+"."+a.collectionName;a.lowla.liveCursors[b]&&a.lowla.liveCursors[b].forEach(function(a){a.callback(null,a.cursor)})}function h(a){var b=this._collection,c=b.dbName+"."+b.collectionName;b.lowla.liveCursors[c]||(b.lowla.liveCursors[c]=[]),b.lowla.liveCursors[c].push({cursor:this,callback:a}),a(null,this)}function i(a){var c=new b(this._collection,this._filter);c._options=this._options;for(var d in a)a.hasOwnProperty(d)&&(c._options[d]=a[d]);return c}function j(a){return this.cloneWithOptions({limit:a})}function k(a){return this.cloneWithOptions({sort:a})}function l(){return this.cloneWithOptions({showPending:!0})}function m(a){if(a)try{this._applyFilter().then(function(b){b.forEach(function(b){a(null,b.document)})})}catch(b){a(b)}}function n(a){var b=this;return Promise.resolve().then(function(){return b._applyFilter()}).then(function(b){return b=b.map(function(a){return a.document}),a&&a(null,b),b},function(b){throw a&&a(b),b})}function o(a,b){function c(a){return 0!==e._options.limit&&(a=Math.min(a,e._options.limit)),b&&b(null,a),a}function d(a){throw b&&b(a),a}"function"==typeof a&&(b=a,a=!1);var e=this;return a||(e=this.cloneWithOptions({skip:0,limit:0})),e._filter?e.toArray().then(function(a){return c(a.length)},d):new Promise(function(a){var b=e._collection,c=b.dbName+"."+b.collectionName;e._collection.datastore.countAll(c,a)}).then(c,d)}return a.Cursor=b,b.prototype.count=o,b.prototype.each=m,b.prototype.limit=j,b.prototype.sort=k,b.prototype.showPending=l,b.prototype.toArray=n,b.prototype.on=h,b.notifyLive=g,b.prototype.cloneWithOptions=i,b.prototype._applyFilter=f,b.prototype._applyFilterInTx=e,a}(LowlaDB),function(a){function b(a,b){return a+"$"+b}var c=this.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,d=function(){return this instanceof d?void 0:new d};d._makeKey=b;var e=!1,f=function(){if(!e){if(!c)throw Error("Unable to identify IndexedDB instance");e=new Promise(function(a,b){var d=c.open("lowla",1);d.onupgradeneeded=function(a){var c=a.target.result;a.target.transaction.onerror=b;var d=c.createObjectStore("lowla");d.createIndex("_id","document._id",{unique:!1})},d.onsuccess=function(b){a(b.target.result)},d.onerror=function(a){b(a)}})}return e};return d.prototype.scanDocuments=function(a,b,c){this.transact(function(d){d.scan(a,b,c)},function(){},c)},d.prototype.transact=function(a,c,d){d=d||function(){},f().then(function(e){function f(a,c,e,f){f=f||d;var g=j.objectStore("lowla"),h=IDBKeyRange.only(b(a,c)),i=g.openCursor(h);i.onsuccess=function(a){var b=a.target.result?a.target.result.value.document:null;e(b,k)},i.onerror=f}function g(a,c,e,f,g){g=g||d;var h=j.objectStore("lowla"),i=h.put({clientNs:a,lowlaId:c,document:e},b(a,c));i.onsuccess=function(){f&&f(e,k)},i.onerror=function(a){g(a)}}function h(a,b,c){var e={};"object"==typeof a&&(b=a.done||function(){},c=a.error,e=a.options||{},a=a.document||function(){}),c=c||d;var f,g=j.objectStore("lowla");if(e._id){var h=g.index("_id"),i=IDBKeyRange.only(e._id);f=h.openCursor(i)}else f=g.openCursor();f.onsuccess=function(c){var d=c.target.result;return d?(a(d.value,k),void d.continue()):void b(k)},f.onerror=function(a){c(a)}}function i(a,c,e,f){f=f||d;var g=j.objectStore("lowla").delete(b(a,c));g.onsuccess=function(){e&&e(k)},g.onerror=f}var j=e.transaction(["lowla"],"readwrite");j.oncomplete=function(){c()},j.onerror=function(a){d(a)};var k={errCb:d,load:f,save:g,scan:h,remove:i};try{a(k)}catch(l){d(l)}})},d.prototype.loadDocument=function(a,c,d,e){f().then(function(f){"object"==typeof d&&(e=d.error||function(a){throw a},d=d.document||function(){});var g=f.transaction(["lowla"],"readwrite"),h=g.objectStore("lowla"),i=IDBKeyRange.only(b(a,c)),j=h.openCursor(i);j.onsuccess=function(a){var b=a.target.result;d(b?b.value.document:null)},j.onerror=function(a){e(a)}})},d.prototype.updateDocument=function(a,c,d,e,g){f().then(function(f){var h=f.transaction(["lowla"],"readwrite"),i=h.objectStore("lowla"),j=i.put({clientNs:a,lowlaId:c,document:d},b(a,c));h.oncomplete=function(){e&&e(d)},j.onerror=function(a){g&&g(a)}})},d.prototype.close=function(){return e?e.then(function(a){e=!1,a.close()}):void 0},d.prototype.countAll=function(a,b,c){f().then(function(d){var e=d.transaction(["lowla"],"readwrite"),f=e.objectStore("lowla"),g=IDBKeyRange.bound(a+"$",a+"%",!1,!0),h=f.count(g);h.onsuccess=function(){b(h.result)},c&&(h.onerror=function(a){c(a)})})},a.registerDatastore("IndexedDB",new d),a}(LowlaDB),function(a){"use strict";function b(a,b){this.name=b,this.datastore=a.datastore}function c(b){return new a.Collection(this.name,b)}function d(){function a(a,b){h.scanDocuments({document:function(a){0===a.clientNs.indexOf(l)&&(k[a.clientNs]=!0)},done:function(){return a(k)},error:b})}function b(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(f.namesOnly?c:{name:c});return b}function c(a){return g&&g(null,a),a}function d(a){throw g&&g(a),a}for(var e,f,g,h=this.datastore,i=Array.prototype.slice.call(arguments,0);i.length>0;){var j=i.pop();j instanceof Function?g=j:"string"==typeof j?e=j:"object"==typeof j&&(f=j)}f=f||{namesOnly:!1},e=e||"";var k={},l=this.name+"."+e;return new Promise(a).then(b).then(c,d)}return a.DB=b,b.prototype.collection=c,b.prototype.collectionNames=d,a}(LowlaDB),function(a){function b(){return this instanceof b?void 0:new b}function c(b){if(b){var d={};a.utils.keys(b).forEach(function(a){d[a]="object"==typeof b[a]?c(b[a]):b[a]}),b=d}return b}function d(){k={}}function e(a,b,c,d){k[a+"$"+b]={clientNs:a,lowlaId:b,document:c},d(c)}function f(a,b,d){"object"==typeof d&&(d=d.document||function(){});var e=k[a+"$"+b];d(e?c(e.document):e)}function g(a,b){this.transact(function(c){c.scan(a,b)},function(){},function(){})}function h(a,b,c){delete k[a+"$"+b],c()}function i(b,c){var d=0;a.utils.keys(k).forEach(function(a){k[a].clientNs===b&&++d}),c(d)}function j(b,d,g){function i(a,b,c){f(a,b,function(a){c&&c(a,n)})}function j(a,b,c,d){e(a,b,c,function(a){d&&d(a,n)})}function l(b,d){"object"==typeof b&&(d=b.done||function(){},b=b.document||function(){}),a.utils.keys(k).forEach(function(a){b(c(k[a]),n)}),d(n)}function m(a,b,c){h(a,b,function(){c&&c(n)})}g=g||function(){};var n={errCb:g,load:i,save:j,scan:l,remove:m};try{setTimeout(function(){d()},0),b(n)}catch(o){g(o)}}var k={};return b.prototype.scanDocuments=g,b.prototype.transact=j,b.prototype.loadDocument=f,b.prototype.updateDocument=e,b.prototype.close=d,b.prototype.countAll=i,a.registerDatastore("Memory",new b),a}(LowlaDB),function(a){var b,c=function(c,d){if(this.lowla=c,this.datastore=c.datastore,b=a.utils.keys,!d||!d.length)throw Error("Invalid server URL for LowlaDB Sync");"/"!=d[d.length-1]&&(d+="/"),this.urls={changes:d+"_lowla/changes",pull:d+"_lowla/pull",push:d+"_lowla/push"}};return c.prototype.processPull=function(a){return c._processPullPayload(this.lowla,this.datastore,a)},c._processPullPayload=function(b,d,e){function f(a,b,c){return new Promise(function(e,f){function g(a){a.load("","$metadata",h)}function h(d,f){d&&d.changes&&d.changes.hasOwnProperty(b)?e():c?f.save(a,b,c):f.remove(a,b)}d.transact(g,e,f)})}for(var g=0,h=[],i={},j=0;g<e.length;)i[e[g].clientNs]=!0,j=Math.max(j,e[g].sequence),e[g].deleted?h.push(f(e[g].clientNs,e[g].id)):(c.validateSpecialTypes(e[g+1]),h.push(f(e[g].clientNs,e[g].id,e[++g]))),g++;return Promise.all(h).then(function(){return a.utils.keys(i).forEach(function(c){var d=c.substring(0,c.indexOf("."));c=c.substring(d.length+1),a.Cursor.notifyLive(b.collection(d,c))}),j})},c._updateSequence=function(a,b){return new Promise(function(c,d){a.datastore.loadDocument("","$metadata",{document:function(e){e||(e={}),e.sequence=b,a.datastore.updateDocument("","$metadata",e,function(){c(b)},d)}})})},c.prototype.processChanges=function(b){function d(b,g){var j=b.slice(0,Math.min(10,b.length));return Promise.resolve().then(function(){return a.utils.getJSON(e.urls.pull,{ids:j})}).then(function(a){if(a.length)for(var c=0;c<a.length;){var d=b.indexOf(a[c].id);-1!==d&&(b.splice(d,1),h.splice(d,1)),a[c].deleted?c++:c+=2}else b.splice(0,j.length),h.splice(0,j.length),i=!1;return e.processPull(a)}).then(function(){return i&&h.length?c._updateSequence(f,h[0]):void 0}).then(function(){return b.length?d(b,g):void 0})}var e=this,f=this.lowla,g=[],h=[],i=!0;return b.atoms.map(function(a){g.push(a.id),h.push(a.sequence)}),0===g.length?Promise.resolve():(f.emit("pullBegin"),Promise.resolve().then(function(){return d(g,0)}).then(function(){return i?c._updateSequence(f,b.sequence):void 0}).then(function(a){return f.emit("pullEnd"),a},function(a){throw f.emit("pullEnd"),a}))},c.prototype.fetchChanges=function(){var b=this;return new Promise(function(a,c){b.datastore.loadDocument("","$metadata",{document:a,error:c})}).then(function(c){var d=c&&c.sequence?c.sequence:0;return a.utils.getJSON(b.urls.changes+"?seq="+d)}).then(function(a){return b.processChanges(a)}).catch(function(a){console.log("Unable to fetch changes: "+a)})},c.validateSpecialTypes=function(a){for(var b in a)if(a.hasOwnProperty(b)){var d=a[b];if("object"==typeof d)if(d.hasOwnProperty("_bsonType"))switch(d._bsonType){case"Binary":case"Date":break;default:throw Error("Unexpected BSON type: "+d._bsonType)}else c.validateSpecialTypes(d)}},c.convertSpecialTypes=function(b){for(var d in b)if(b.hasOwnProperty(d)){var e=b[d];if("object"==typeof e)if(e.hasOwnProperty("_bsonType"))switch(e._bsonType){case"Binary":b[d]=a.utils.b64toBlob(e.encoded),b[d]._lowlaType=e.type;break;case"Date":b[d]=new Date(parseInt(e.millis));break;default:throw Error("Unexpected BSON type: "+e._bsonType)}else c.convertSpecialTypes(e)}return b},c.prototype.collectPushData=function(c){var d=this.datastore;return c=c||{},this.lowla._metadata().then(function(e){return e&&e.changes?new Promise(function(f,g){var h=[];d.scanDocuments(function(a){var d=a.lowlaId;if(a=a.document,!(h.length>=10||c.hasOwnProperty(d))&&(c[d]=!0,e.changes.hasOwnProperty(d))){var f=e.changes[d],g={},i={};for(var j in a)a.hasOwnProperty(j)&&"_id"!==j&&JSON.stringify(a[j])!==JSON.stringify(f[j])&&(g[j]=a[j]);for(var k in f)f.hasOwnProperty(k)&&"_id"!==j&&(a.hasOwnProperty(k)||(i[k]=1));var l=null;0!==b(g).length&&(l={$set:g}),0!==b(i).length&&((l||(l={})).$unset=i),l&&h.push({_lowla:{id:d,version:f._version},ops:l})}},function(){return h.length>=10?void f(h):(a.utils.keys(e.changes).forEach(function(a){c.hasOwnProperty(a)||h.push({_lowla:{id:a,version:e.changes[a]._version,deleted:!0}})}),void f(h))},g)}).then(function(a){return a&&0!==a.length?{documents:a}:null}):null})},c.prototype.processPushResponse=function(a,b){var d=this.lowla;b=b||[];for(var e=function(a){return function(){return a}},f=0,g=[];f<a.length;)if(-1===b.indexOf(a[f].id)){var h=a[f].clientNs.indexOf("."),i=a[f].clientNs.substring(0,h),j=a[f].clientNs.substring(h+1),k=d.collection(i,j);if(a[f].deleted)g.push(k._removeDocument(a[f].id,!0).then(e(a[f].id)));else{var l=a[f].id,m=a[f].clientId,n=a[++f];c.validateSpecialTypes(n);var o=k._updateDocument(l,n,!0,m).then(e(m||l));g.push(o)}f++}else f+=a[f].deleted?1:2;return Promise.all(g)},c.prototype.clearPushData=function(a){var b=this.lowla;return b._metadata().then(function(c){return c&&c.changes?(a&&a.forEach?a.forEach(function(a){delete c.changes[a]}):a&&c.changes.hasOwnProperty(a)?delete c.changes[a]:a||delete c.changes,b._metadata(c)):void 0})},c.prototype.pushChanges=function(){function b(c){return c?Promise.resolve().then(function(){return a.utils.getJSON(d.urls.push,c)}).then(function(a){return d.processPushResponse(a,g)}).then(function(a){return d.clearPushData(a)}).then(function(){return d.collectPushData(f)}).then(b):Promise.resolve()}function c(a,b){g.push(b)}var d=this,e=this.lowla,f={},g=[];return this.collectPushData(f).then(function(a){return a?(e.on("_saveHook",c),e.emit("pushBegin"),b(a).then(function(a){return e.off("_saveHook",c),e.emit("pushEnd"),a},function(a){throw e.off("_saveHook",c),e.emit("pushEnd"),a})):void 0}).catch(function(a){console.log("Unable to push changes: "+a)})},a.SyncCoordinator=c,a}(LowlaDB),function(a){function b(){var a;if(window.ActiveXObject)try{a=new ActiveXObject("Microsoft.XMLHTTP")}catch(b){alert(b.message),a=null}else a=new XMLHttpRequest;return a}var c=a.utils||{};return c.getJSON=function(a,c){var d=b();return new Promise(function(b,e){if(d.onreadystatechange=function(){4===d.readyState&&(200===d.status?b(JSON.parse(d.responseText)):e(d.statusText))},c){var f=JSON.stringify(c);d.open("POST",a,!0),d.setRequestHeader("Content-type","application/json"),d.send(f)}else d.open("GET",a,!0),d.send()})},c.b64toBlob=function(a,b,c){b=b||"",c=c||512;for(var d=atob(a),e=[],f=0;f<d.length;f+=c){for(var g=d.slice(f,f+c),h=new Array(g.length),i=0;i<g.length;i++)h[i]=g.charCodeAt(i);var j=new Uint8Array(h);e.push(j)}return new Blob(e,{type:b})},c.keys=function(a){if(!a)return[];if(Object.keys)return Object.keys(a);var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b},c.isArray=function(a){return a instanceof Array},c.debounce=function(a,b,c){var d;return function(){var e=this,f=arguments,g=function(){d=null,c||a.apply(e,f)},h=c&&!d;clearTimeout(d),d=setTimeout(g,b),h&&a.apply(e,f)}},a.utils=c,a}(LowlaDB),function(){var a,b,c,d;!function(){var e={},f={};a=function(a,b,c){e[a]={deps:b,callback:c}},d=c=b=function(a){function c(b){if("."!==b.charAt(0))return b;for(var c=b.split("/"),d=a.split("/").slice(0,-1),e=0,f=c.length;f>e;e++){var g=c[e];if(".."===g)d.pop();else{if("."===g)continue;d.push(g)}}return d.join("/")}if(d._eak_seen=e,f[a])return f[a];if(f[a]={},!e[a])throw new Error("Could not find module "+a);for(var g,h=e[a],i=h.deps,j=h.callback,k=[],l=0,m=i.length;m>l;l++)k.push("exports"===i[l]?g={}:b(c(i[l])));var n=j.apply(this,k);return f[a]=g||n}}(),a("promise/all",["./utils","exports"],function(a,b){"use strict";function c(a){var b=this;if(!d(a))throw new TypeError("You must pass an array to all.");return new b(function(b,c){function d(a){return function(b){f(a,b)}}function f(a,c){h[a]=c,0===--i&&b(h)}var g,h=[],i=a.length;0===i&&b([]);for(var j=0;j<a.length;j++)g=a[j],g&&e(g.then)?g.then(d(j),c):f(j,g)})}var d=a.isArray,e=a.isFunction;b.all=c}),a("promise/asap",["exports"],function(a){"use strict";function b(){return function(){process.nextTick(e)}}function c(){var a=0,b=new i(e),c=document.createTextNode("");return b.observe(c,{characterData:!0}),function(){c.data=a=++a%2}}function d(){return function(){j.setTimeout(e,1)}}function e(){for(var a=0;a<k.length;a++){var b=k[a],c=b[0],d=b[1];c(d)}k=[]}function f(a,b){var c=k.push([a,b]);1===c&&g()}var g,h="undefined"!=typeof window?window:{},i=h.MutationObserver||h.WebKitMutationObserver,j="undefined"!=typeof global?global:void 0===this?window:this,k=[];g="undefined"!=typeof process&&"[object process]"==={}.toString.call(process)?b():i?c():d(),a.asap=f}),a("promise/config",["exports"],function(a){"use strict";function b(a,b){return 2!==arguments.length?c[a]:void(c[a]=b)}var c={instrument:!1};a.config=c,a.configure=b}),a("promise/polyfill",["./promise","./utils","exports"],function(a,b,c){"use strict";function d(){var a;a="undefined"!=typeof global?global:"undefined"!=typeof window&&window.document?window:self;var b="Promise"in a&&"resolve"in a.Promise&&"reject"in a.Promise&&"all"in a.Promise&&"race"in a.Promise&&function(){var b;return new a.Promise(function(a){b=a}),f(b)}();b||(a.Promise=e)}var e=a.Promise,f=b.isFunction;c.polyfill=d}),a("promise/promise",["./config","./utils","./all","./race","./resolve","./reject","./asap","exports"],function(a,b,c,d,e,f,g,h){"use strict";function i(a){if(!v(a))throw new TypeError("You must pass a resolver function as the first argument to the promise constructor");if(!(this instanceof i))throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.");this._subscribers=[],j(a,this)}function j(a,b){function c(a){o(b,a)}function d(a){q(b,a)}try{a(c,d)}catch(e){d(e)}}function k(a,b,c,d){var e,f,g,h,i=v(c);if(i)try{e=c(d),g=!0}catch(j){h=!0,f=j}else e=d,g=!0;n(b,e)||(i&&g?o(b,e):h?q(b,f):a===D?o(b,e):a===E&&q(b,e))}function l(a,b,c,d){var e=a._subscribers,f=e.length;e[f]=b,e[f+D]=c,e[f+E]=d}function m(a,b){for(var c,d,e=a._subscribers,f=a._detail,g=0;g<e.length;g+=3)c=e[g],d=e[g+b],k(b,c,d,f);a._subscribers=null}function n(a,b){var c,d=null;try{if(a===b)throw new TypeError("A promises callback cannot return that same promise.");if(u(b)&&(d=b.then,v(d)))return d.call(b,function(d){return c?!0:(c=!0,void(b!==d?o(a,d):p(a,d)))},function(b){return c?!0:(c=!0,void q(a,b))}),!0}catch(e){return c?!0:(q(a,e),!0)}return!1}function o(a,b){a===b?p(a,b):n(a,b)||p(a,b)}function p(a,b){a._state===B&&(a._state=C,a._detail=b,t.async(r,a))}function q(a,b){a._state===B&&(a._state=C,a._detail=b,t.async(s,a))}function r(a){m(a,a._state=D)}function s(a){m(a,a._state=E)}var t=a.config,u=(a.configure,b.objectOrFunction),v=b.isFunction,w=(b.now,c.all),x=d.race,y=e.resolve,z=f.reject,A=g.asap;t.async=A;var B=void 0,C=0,D=1,E=2;i.prototype={constructor:i,_state:void 0,_detail:void 0,_subscribers:void 0,then:function(a,b){var c=this,d=new this.constructor(function(){});if(this._state){var e=arguments;t.async(function(){k(c._state,d,e[c._state-1],c._detail)})}else l(this,d,a,b);return d},"catch":function(a){return this.then(null,a)}},i.all=w,i.race=x,i.resolve=y,i.reject=z,h.Promise=i}),a("promise/race",["./utils","exports"],function(a,b){"use strict";function c(a){var b=this;if(!d(a))throw new TypeError("You must pass an array to race.");return new b(function(b,c){for(var d,e=0;e<a.length;e++)d=a[e],d&&"function"==typeof d.then?d.then(b,c):b(d)})}var d=a.isArray;b.race=c}),a("promise/reject",["exports"],function(a){"use strict";function b(a){var b=this;return new b(function(b,c){c(a)})}a.reject=b}),a("promise/resolve",["exports"],function(a){"use strict";function b(a){if(a&&"object"==typeof a&&a.constructor===this)return a;var b=this;return new b(function(b){b(a)})}a.resolve=b}),a("promise/utils",["exports"],function(a){"use strict";function b(a){return c(a)||"object"==typeof a&&null!==a}function c(a){return"function"==typeof a}function d(a){return"[object Array]"===Object.prototype.toString.call(a)}var e=Date.now||function(){return(new Date).getTime()};a.objectOrFunction=b,a.isFunction=c,a.isArray=d,a.now=e}),b("promise/polyfill").polyfill()}();